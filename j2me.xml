<?xml version="1.0" encoding="iso-8859-1" ?>

<project name="JavaGear" default="build" basedir=".">

	<!-- Load properties file -->
	<property file="build.properties" />
	
	<!-- Setup Antenna properties -->
	<property name="wtk.home" value="${WTK}"/>
	<property name="wtk.midp.version" value="2.0"/>
	<property name="wtk.mmapi.enabled" value="false"/>

	<!-- Read Antenna Properties (http://antenna.sourceforge.net) -->
	<taskdef resource="antenna.properties"/>
	
	<!-- set global properties for this build -->  
	<property name="romtool"  location="${basedir}/romtool"/>
	  
	<property name="jdk" value="${sun.boot.library.path}\..\lib\rt.jar" />
	<property name="classpath" value="${java.class.path};${jdk}" />
	
  	<!-- Accuracy Label -->
  	<condition property="buildType" value="accurate" else="fast">
		<equals arg1="${ACCURATE}" arg2="true" />
	</condition>
	
	<condition property="doObfuscate">
		<equals arg1="${OBFUSCATE}" arg2="true" />
	</condition>
	
	<!-- Default filename -->
	<condition property="baseName" value="JavaGearME_midp_${buildType}_${VERSION}">
		<not>
			<isset property="baseName" />
		</not>	
	</condition>
	
	<property name="jadPath" value="${basedir}/dist/${baseName}.jad" />
	<property name="jarPath" value="${basedir}/dist/${baseName}.jar" />
	
	<!-- Source files to compile -->
	<patternset id="sourcePattern">
		<include name="common/*.java" />
		<include name="platforms/midp2/*.java" />
	</patternset>

	<target name="build">

		<!-- Create a JAD file. -->

		<wtkjad jadfile="${jadPath}"
                jarfile="${jarPath}"
                name="JavaGear"
                vendor="Chris White"
                version="${VERSION}">

			<midlet name="JavaGear" class="JavaGear" icon="i.png" />

		</wtkjad>

		<delete dir="classes"/>
		<mkdir dir="classes"/>

		<!-- Compile everything, but don't preverify (yet). -->
		
				<echo file="src/common/BuildSettings.java">
/* This file is autogenerated. Please do not edit manually */
    
public class BuildSettings
{
  public final static String VERSION = "${VERSION}";

  public final static boolean ACCURATE = ${ACCURATE};
}</echo>

		<wtkbuild srcdir="src"
                  destdir="classes"
                  preverify="false"
				  target="1.1" source="1.3">
			
		<patternset refid="sourcePattern" />
			
		</wtkbuild>

		<!-- Package everything. Most of the necessary information is
             contained in the JAD file. Also preverify the result this
             time. To obfuscate everything, set the corresponding
             parameter to "true" (requires RetroGuard or ProGuard). The
             version parameter increments the MIDlet-Version by one. -->
		
		<wtkpackage jarfile="${jarPath}"
                    jadfile="${jadPath}"
                    obfuscate="false"
                    preverify="false">

			<!-- Package our newly compiled classes. -->
			<fileset dir="${basedir}/classes"/>
			
			<!-- Package resources -->
			<fileset dir="${basedir}/res"/>

		</wtkpackage>
		
	    <wtkobfuscate
			if="doObfuscate"
		    jarfile="${jarPath}"
			jadfile="${jadPath}">
		
			<argument value="-microedition"/>
		
		</wtkobfuscate>

		<!-- Preverify. -->

		<wtkpreverify jarfile="${jarPath}"
                      jadfile="${jadPath}"/>

	</target>
	
	<target name="run">
	
  	<!-- Compile RomTool -->
  	<javac srcdir="${romtool}" destdir="${romtool}" source="1.3" target="1.1">
  		<bootclasspath path="${classpath}" />
  	</javac>

		<!-- Add ROM to package -->
		<java classname="RomTool"
			failonerror="true"
			fork="true"
			classpath="${romtool}"
			dir="${romtool}">
			
			<!-- Catridge to compile -->
			<arg value="${basedir}/rom/${ROM}" />
			
			<!-- JAD of package -->
			<arg value="${jadPath}" />
		</java>
		
		<!-- Start the MIDlet suite -->
		<wtkrun
			jadfile="${jadPath}" 
			device="DefaultColorPhone" 
			wait="true"
			heapsize="4M"/>
	</target>

</project>
